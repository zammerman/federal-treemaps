<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Statistical Agencies Appropriations Treemap</title>
    <link href="https://fonts.googleapis.com/css2?family=Faustina:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Faustina', serif;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            align-items: center;
            background: transparent;
        }
        
        #chart {
            background: transparent;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 13px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .bubble {
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .bubble:hover {
            opacity: 0.8;
            stroke: #333;
            stroke-width: 2;
        }
        
        .bubble-label {
            font-family: 'Faustina', serif;
            pointer-events: none;
            text-anchor: middle;
            fill: white;
            font-weight: 600;
        }
        
        .legend-container {
            display: flex;
            flex-direction: column;
            margin-left: 30px;
            font-family: 'Faustina', serif;
        }
        
        .legend-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-family: 'Faustina', serif;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .legend-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="chart"></div>
        <div class="tooltip"></div>
        <div class="legend-container">
            <div class="legend-title">Department</div>
            <div class="legend" id="legend"></div>
        </div>
    </div>
    
    <script>
        const data = {
            name: "Federal Statistical Agencies",
            children: [
                {
                    name: "Agriculture",
                    children: [
                        {name: "Economic Research Service (ERS)", value: 87.80},
                        {name: "National Agricultural Statistics Service (NASS)", value: 190.20}
                    ]
                },
                {
                    name: "Commerce",
                    children: [
                        {name: "Bureau of Economic Analysis (BEA)", value: 111.70},
                        {name: "Bureau of the Census", value: 1579.80}
                    ]
                },
                {
                    name: "Education",
                    children: [
                        {name: "National Center for Education Statistics (NCES)", value: 334.40}
                    ]
                },
                {
                    name: "Energy",
                    children: [
                        {name: "Energy Information Administration (EIA)", value: 129.00}
                    ]
                },
                {
                    name: "Health and Human Services",
                    children: [
                        {name: "National Center for Health Statistics (NCHS)", value: 180.40}
                    ]
                },
                {
                    name: "Justice",
                    children: [
                        {name: "Bureau of Justice Statistics (BJS)", value: 49.40}
                    ]
                },
                {
                    name: "Labor",
                    children: [
                        {name: "Bureau of Labor Statistics (BLS)", value: 688.00}
                    ]
                },
                {
                    name: "National Science Foundation",
                    children: [
                        {name: "National Center for Science and Engineering Statistics (NCSES)", value: 67.70}
                    ]
                },
                {
                    name: "Social Security Administration",
                    children: [
                        {name: "Office of Research, Evaluation, and Statistics (ORES)", value: 38.20}
                    ]
                },
                {
                    name: "Transportation",
                    children: [
                        {name: "Bureau of Transportation Statistics (BTS)", value: 30.80}
                    ]
                },
                {
                    name: "Treasury",
                    children: [
                        {name: "IRS Statistics of Income (SOI) Program", value: 42.40}
                    ]
                }
            ]
        };

        // ============================================
        // CHANGE COLORS HERE - Each department needs a unique color
        // ============================================
        const departmentColors = {
            "Agriculture": "#1B83C6",           // Blue
            "Commerce": "#05335D",              // Dark Blue
            "Education": "#B71D51",             // Red
            "Energy": "#F26961",                // Light Red
            "Health and Human Services": "#FCBB13",  // Yellow
            "Justice": "#6BAED6",               // Light Blue - CHANGE THIS
            "Labor": "#08519C",                 // Medium Blue - CHANGE THIS
            "National Science Foundation": "#E74C70",  // Pink - CHANGE THIS
            "Social Security Administration": "#FDB863",  // Light Orange - CHANGE THIS
            "Transportation": "#2166AC",        // Another Blue - CHANGE THIS
            "Treasury": "#D94801"               // Dark Orange - CHANGE THIS
        };
        // ============================================
        
        const width = 900;
        const height = 700;
        
        const departments = data.children.map(d => d.name);
        
        // Create legend
        const legend = d3.select("#legend");
        departments.forEach(dept => {
            const item = legend.append("div")
                .attr("class", "legend-item")
                .attr("data-department", dept);
            item.append("div")
                .attr("class", "legend-color")
                .style("background-color", departmentColors[dept]);
            item.append("span")
                .text(dept);
        });
        
        const pack = d3.pack()
            .size([width, height])
            .padding(3);
        
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);
        
        pack(root);
        
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        const tooltip = d3.select(".tooltip");
        
        const nodes = svg.selectAll(".node")
            .data(root.descendants().filter(d => d.depth === 2))
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);
        
        const bubbles = nodes.append("circle")
            .attr("class", "bubble")
            .attr("data-department", d => d.parent.data.name)
            .attr("r", d => d.r)
            .style("fill", d => departmentColors[d.parent.data.name])
            .style("fill-opacity", 0.8)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>
                    Department: ${d.parent.data.name}<br/>
                    Funding: $${d.data.value.toFixed(1)}M`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        
        // Add labels for bubbles
        const labels = nodes.each(function(d) {
            const node = d3.select(this);
            const text = node.append("text")
                .attr("class", "bubble-label")
                .attr("dy", ".3em");
            
            // For very large bubbles (Census), we can use full name
            if (d.r > 100) {
                text.style("font-size", "16px")
                    .text(d.data.name);
            }
            // For medium bubbles, use abbreviated names
            else if (d.r > 40) {
                text.style("font-size", d => Math.min(d.r / 5, 14) + "px")
                    .text(d => {
                        // Extract acronym from name if it exists
                        const match = d.data.name.match(/\(([^)]+)\)/);
                        if (match) {
                            return match[1];
                        }
                        // Otherwise use first few words
                        const words = d.data.name.split(' ');
                        return words.slice(0, 2).join(' ');
                    });
            }
            // For smaller bubbles, use just acronym or very short text
            else if (d.r > 20) {
                text.style("font-size", d => Math.min(d.r / 4, 10) + "px")
                    .text(d => {
                        const match = d.data.name.match(/\(([^)]+)\)/);
                        if (match) {
                            return match[1];
                        }
                        return d.data.name.split(' ')[0];
                    });
            }
            // For tiny bubbles, add value instead of name
            else if (d.r > 15) {
                text.style("font-size", "8px")
                    .text(d => "$" + d.data.value.toFixed(0) + "M");
            }
        });
        
        // Add interactive filtering on legend hover
        d3.selectAll(".legend-item")
            .on("mouseenter", function(event) {
                const hoveredDept = d3.select(this).attr("data-department");
                
                // Dim all bubbles except the hovered department
                bubbles.transition()
                    .duration(200)
                    .style("opacity", d => d.parent.data.name === hoveredDept ? 1 : 0.2);
                
                // Also dim the labels
                nodes.selectAll(".bubble-label")
                    .transition()
                    .duration(200)
                    .style("opacity", function() {
                        const parentNode = d3.select(this.parentNode).datum();
                        return parentNode.parent.data.name === hoveredDept ? 1 : 0.2;
                    });
            })
            .on("mouseleave", function() {
                // Reset all bubbles to normal opacity
                bubbles.transition()
                    .duration(200)
                    .style("opacity", 0.8);
                
                // Reset all labels
                nodes.selectAll(".bubble-label")
                    .transition()
                    .duration(200)
                    .style("opacity", 1);
            });
    </script>
</body>
</html>