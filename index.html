<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Federal Statistical Agencies Treemap</title>
    <link href="https://fonts.googleapis.com/css2?family=Faustina:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 690px;
            height: 540px;
            overflow: hidden;
            background: transparent;
        }
        
        #container {
            width: 690px;
            height: 540px;
            position: relative;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font: 12px sans-serif;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        
        #legend {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-family: 'Faustina', serif;
        }
        
        .legend-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .legend-row {
            margin-bottom: 3px;
        }
        
        .legend-item {
            display: inline-block;
            margin: 0 5px;
            font-size: 9px;
            cursor: pointer;
            padding: 2px;
        }
        
        .legend-item:hover {
            background: rgba(200,200,200,0.3);
        }
        
        .color-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="treemap" width="690" height="440"></canvas>
        <div class="tooltip"></div>
        <div id="legend">
            <div class="legend-title">Department</div>
        </div>
    </div>
    
    <script>
        // Set up canvas
        const canvas = document.getElementById('treemap');
        const ctx = canvas.getContext('2d');
        const width = 690;
        const height = 440;
        
        // Make sure canvas is exactly the right size
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        
        // Data
        const data = {
            name: "Federal Statistical Agencies",
            children: [
                {
                    name: "Agriculture",
                    children: [
                        {name: "Economic Research Service (ERS)", value: 87.80},
                        {name: "National Agricultural Statistics Service (NASS)", value: 190.20}
                    ]
                },
                {
                    name: "Commerce",
                    children: [
                        {name: "Bureau of Economic Analysis (BEA)", value: 111.70},
                        {name: "Bureau of the Census", value: 1579.80}
                    ]
                },
                {
                    name: "Education",
                    children: [
                        {name: "National Center for Education Statistics (NCES)", value: 334.40}
                    ]
                },
                {
                    name: "Energy",
                    children: [
                        {name: "Energy Information Administration (EIA)", value: 129.00}
                    ]
                },
                {
                    name: "Health and Human Services",
                    children: [
                        {name: "National Center for Health Statistics (NCHS)", value: 180.40}
                    ]
                },
                {
                    name: "Justice",
                    children: [
                        {name: "Bureau of Justice Statistics (BJS)", value: 49.40}
                    ]
                },
                {
                    name: "Labor",
                    children: [
                        {name: "Bureau of Labor Statistics (BLS)", value: 688.00}
                    ]
                },
                {
                    name: "National Science Foundation",
                    children: [
                        {name: "National Center for Science and Engineering Statistics (NCSES)", value: 67.70}
                    ]
                },
                {
                    name: "Social Security Administration",
                    children: [
                        {name: "Office of Research, Evaluation, and Statistics (ORES)", value: 38.20}
                    ]
                },
                {
                    name: "Transportation",
                    children: [
                        {name: "Bureau of Transportation Statistics (BTS)", value: 30.80}
                    ]
                },
                {
                    name: "Treasury",
                    children: [
                        {name: "IRS Statistics of Income (SOI) Program", value: 42.40}
                    ]
                }
            ]
        };

        // Colors
        const departmentColors = {
            "Agriculture": "#1B83C6",
            "Commerce": "#05335D",
            "Education": "#B71D51",
            "Energy": "#F26961",
            "Health and Human Services": "#FCBB13",
            "Justice": "#7A4FA3",
            "Labor": "#4CAF50",
            "National Science Foundation": "#9C27B0",
            "Social Security Administration": "#00BCD4",
            "Transportation": "#795548",
            "Treasury": "#607D8B"
        };
        
        // Create pack layout
        const pack = d3.pack()
            .size([width - 40, height - 40])
            .padding(8);
        
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);
        
        pack(root);
        
        // Store bubble data for interaction
        const bubbles = root.descendants().filter(d => d.depth === 2).map(d => ({
            x: d.x + 20,
            y: d.y + 20,
            r: d.r,
            name: d.data.name,
            value: d.data.value,
            department: d.parent.data.name,
            color: departmentColors[d.parent.data.name]
        }));
        
        // Draw function
        function draw(highlightDept = null) {
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw bubbles
            bubbles.forEach(bubble => {
                const opacity = highlightDept ? (bubble.department === highlightDept ? 1 : 0.2) : 0.8;
                
                // Draw circle
                ctx.beginPath();
                ctx.arc(bubble.x, bubble.y, bubble.r, 0, 2 * Math.PI);
                ctx.fillStyle = hexToRgba(bubble.color, opacity);
                ctx.fill();
                
                // Draw text if bubble is large enough
                if (bubble.r > 14) {
                    ctx.save();
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold ' + getFontSize(bubble.r) + 'px Faustina';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const text = getLabel(bubble);
                    if (text) {
                        // Clip text to circle
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(bubble.x, bubble.y, bubble.r - 2, 0, 2 * Math.PI);
                        ctx.clip();
                        ctx.fillText(text, bubble.x, bubble.y);
                        ctx.restore();
                    }
                    ctx.restore();
                }
            });
        }
        
        // Helper functions
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        function getFontSize(radius) {
            if (radius > 60) return 12;
            if (radius > 40) return 10;
            if (radius > 22) return 8;
            return 6;
        }
        
        function getLabel(bubble) {
            if (bubble.name.includes("Census")) return "Census";
            const match = bubble.name.match(/\(([^)]+)\)/);
            if (match) return match[1];
            if (bubble.r > 40) return bubble.name.split(' ')[0];
            if (bubble.r > 22) {
                const first = bubble.name.split(' ')[0];
                return first.length > 6 ? first.substring(0, 4) : first;
            }
            return "";
        }
        
        // Mouse interaction
        const tooltip = d3.select('.tooltip');
        
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Find bubble under mouse
            let hoveredBubble = null;
            for (let bubble of bubbles) {
                const dx = x - bubble.x;
                const dy = y - bubble.y;
                if (Math.sqrt(dx * dx + dy * dy) <= bubble.r) {
                    hoveredBubble = bubble;
                    break;
                }
            }
            
            if (hoveredBubble) {
                canvas.style.cursor = 'pointer';
                tooltip.transition().duration(200).style('opacity', .9);
                tooltip.html(`<strong>${hoveredBubble.name}</strong><br/>
                    Department: ${hoveredBubble.department}<br/>
                    Funding: $${hoveredBubble.value.toFixed(1)}M`)
                    .style('left', (e.pageX + 10) + 'px')
                    .style('top', (e.pageY - 28) + 'px');
            } else {
                canvas.style.cursor = 'default';
                tooltip.transition().duration(500).style('opacity', 0);
            }
        });
        
        canvas.addEventListener('mouseout', function() {
            tooltip.transition().duration(500).style('opacity', 0);
        });
        
        // Create legend
        const legendDiv = document.getElementById('legend');
        const rows = [
            ["Agriculture", "Commerce", "Education", "Energy"],
            ["Health and Human Services", "Justice", "Labor", "National Science Foundation"],
            ["Social Security Administration", "Transportation", "Treasury"]
        ];
        
        rows.forEach(rowDepts => {
            const row = document.createElement('div');
            row.className = 'legend-row';
            
            rowDepts.forEach(dept => {
                const item = document.createElement('span');
                item.className = 'legend-item';
                item.setAttribute('data-department', dept);
                
                const dot = document.createElement('span');
                dot.className = 'color-dot';
                dot.style.backgroundColor = departmentColors[dept];
                
                const label = document.createElement('span');
                label.textContent = dept;
                
                item.appendChild(dot);
                item.appendChild(label);
                row.appendChild(item);
                
                // Add hover interaction
                item.addEventListener('mouseenter', function() {
                    draw(dept);
                });
                
                item.addEventListener('mouseleave', function() {
                    draw(null);
                });
            });
            
            legendDiv.appendChild(row);
        });
        
        // Initial draw
        draw();
        
        // Prevent any scaling
        window.addEventListener('resize', function(e) {
            e.preventDefault();
            canvas.width = 690;
            canvas.height = 440;
            canvas.style.width = '690px';
            canvas.style.height = '440px';
            draw();
        });
    </script>
</body>
</html>
