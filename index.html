<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Federal Statistical Agencies Appropriations Treemap</title>
    <link href="https://fonts.googleapis.com/css2?family=Faustina:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 690px;
            overflow: hidden;
        }
        
        #wrapper {
            width: 690px;
            height: 540px;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            background: transparent;
        }
        
        #viz {
            width: 690px;
            height: 540px;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .tooltip {
            position: fixed;
            text-align: left;
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        text {
            font-family: 'Faustina', serif;
            fill: white;
            font-weight: 600;
            pointer-events: none;
        }
        
        .legend-wrap {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 690px;
            padding: 10px;
            background: transparent;
        }
        
        .legend-title {
            text-align: center;
            font-family: 'Faustina', serif;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .legend-row {
            text-align: center;
            margin-bottom: 3px;
        }
        
        .legend-item {
            display: inline-block;
            font-family: 'Faustina', serif;
            font-size: 9px;
            margin: 0 4px;
            padding: 2px 3px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .legend-item:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .legend-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 3px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="viz"></div>
        <div class="tooltip"></div>
    </div>
    
    <script>
        // Data
        const data = {
            name: "Federal Statistical Agencies",
            children: [
                {
                    name: "Agriculture",
                    children: [
                        {name: "Economic Research Service (ERS)", value: 87.80},
                        {name: "National Agricultural Statistics Service (NASS)", value: 190.20}
                    ]
                },
                {
                    name: "Commerce",
                    children: [
                        {name: "Bureau of Economic Analysis (BEA)", value: 111.70},
                        {name: "Bureau of the Census", value: 1579.80}
                    ]
                },
                {
                    name: "Education",
                    children: [
                        {name: "National Center for Education Statistics (NCES)", value: 334.40}
                    ]
                },
                {
                    name: "Energy",
                    children: [
                        {name: "Energy Information Administration (EIA)", value: 129.00}
                    ]
                },
                {
                    name: "Health and Human Services",
                    children: [
                        {name: "National Center for Health Statistics (NCHS)", value: 180.40}
                    ]
                },
                {
                    name: "Justice",
                    children: [
                        {name: "Bureau of Justice Statistics (BJS)", value: 49.40}
                    ]
                },
                {
                    name: "Labor",
                    children: [
                        {name: "Bureau of Labor Statistics (BLS)", value: 688.00}
                    ]
                },
                {
                    name: "National Science Foundation",
                    children: [
                        {name: "National Center for Science and Engineering Statistics (NCSES)", value: 67.70}
                    ]
                },
                {
                    name: "Social Security Administration",
                    children: [
                        {name: "Office of Research, Evaluation, and Statistics (ORES)", value: 38.20}
                    ]
                },
                {
                    name: "Transportation",
                    children: [
                        {name: "Bureau of Transportation Statistics (BTS)", value: 30.80}
                    ]
                },
                {
                    name: "Treasury",
                    children: [
                        {name: "IRS Statistics of Income (SOI) Program", value: 42.40}
                    ]
                }
            ]
        };

        // Colors
        const departmentColors = {
            "Agriculture": "#1B83C6",
            "Commerce": "#05335D",
            "Education": "#B71D51",
            "Energy": "#F26961",
            "Health and Human Services": "#FCBB13",
            "Justice": "#7A4FA3",
            "Labor": "#4CAF50",
            "National Science Foundation": "#9C27B0",
            "Social Security Administration": "#00BCD4",
            "Transportation": "#795548",
            "Treasury": "#607D8B"
        };
        
        // Create SVG with absolute sizing
        const svg = d3.select("#viz")
            .append("svg")
            .attr("width", 690)
            .attr("height", 440)
            .attr("viewBox", "0 0 690 440")
            .attr("preserveAspectRatio", "xMinYMin slice");
        
        // Create pack layout
        const pack = d3.pack()
            .size([650, 400])
            .padding(8);
        
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);
        
        pack(root);
        
        // Create tooltip
        const tooltip = d3.select(".tooltip");
        
        // Draw bubbles
        const nodes = svg.selectAll(".node")
            .data(root.descendants().filter(d => d.depth === 2))
            .enter().append("g")
            .attr("transform", d => `translate(${d.x + 20},${d.y + 20})`);
        
        const bubbles = nodes.append("circle")
            .attr("r", d => d.r)
            .style("fill", d => departmentColors[d.parent.data.name])
            .style("fill-opacity", 0.8)
            .style("cursor", "pointer")
            .attr("data-department", d => d.parent.data.name)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>
                    Department: ${d.parent.data.name}<br/>
                    Funding: $${d.data.value.toFixed(1)}M`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        
        // Add labels
        nodes.each(function(d) {
            const node = d3.select(this);
            const text = node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", ".3em");
            
            if (d.r > 60) {
                if (d.data.name.includes("Census")) {
                    text.style("font-size", "12px").text("Census");
                } else {
                    const match = d.data.name.match(/\(([^)]+)\)/);
                    text.style("font-size", "12px").text(match ? match[1] : d.data.name.split(' ')[0]);
                }
            } else if (d.r > 40) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                text.style("font-size", "10px").text(match ? match[1] : d.data.name.split(' ')[0]);
            } else if (d.r > 22) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                if (match) {
                    text.style("font-size", "8px").text(match[1]);
                }
            } else if (d.r > 14) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                if (match && match[1].length <= 4) {
                    text.style("font-size", "6px").text(match[1]);
                }
            }
        });
        
        // Create legend
        const legendWrap = d3.select("#viz").append("div")
            .attr("class", "legend-wrap");
        
        legendWrap.append("div")
            .attr("class", "legend-title")
            .text("Department");
        
        const departments = data.children.map(d => d.name);
        
        // Three rows
        const rows = [
            ["Agriculture", "Commerce", "Education", "Energy"],
            ["Health and Human Services", "Justice", "Labor", "National Science Foundation"],
            ["Social Security Administration", "Transportation", "Treasury"]
        ];
        
        rows.forEach(rowDepts => {
            const row = legendWrap.append("div")
                .attr("class", "legend-row");
            
            rowDepts.forEach(dept => {
                const item = row.append("span")
                    .attr("class", "legend-item")
                    .attr("data-department", dept)
                    .on("mouseenter", function() {
                        const hoveredDept = d3.select(this).attr("data-department");
                        bubbles.transition()
                            .duration(200)
                            .style("opacity", d => d.parent.data.name === hoveredDept ? 1 : 0.2);
                        nodes.selectAll("text")
                            .transition()
                            .duration(200)
                            .style("opacity", function() {
                                const parentNode = d3.select(this.parentNode).datum();
                                return parentNode.parent.data.name === hoveredDept ? 1 : 0.2;
                            });
                    })
                    .on("mouseleave", function() {
                        bubbles.transition()
                            .duration(200)
                            .style("opacity", 0.8);
                        nodes.selectAll("text")
                            .transition()
                            .duration(200)
                            .style("opacity", 1);
                    });
                
                item.append("span")
                    .attr("class", "legend-dot")
                    .style("background-color", departmentColors[dept]);
                
                item.append("span")
                    .text(dept);
            });
        });
    </script>
</body>
</html>
