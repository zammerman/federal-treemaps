<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=690, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Federal Statistical Agencies Appropriations Treemap</title>
    <link href="https://fonts.googleapis.com/css2?family=Faustina:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Faustina', serif;
            background-color: transparent;
        }
        
        .container {
            width: 690px;
            height: auto;
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            position: relative;
        }
        
        #chart {
            background: transparent;
            position: relative;
            width: 580px;
            height: 440px;
            margin: 0 auto;
            display: block;
        }
        
        .tooltip {
            position: fixed;
            text-align: left;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .bubble {
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .bubble:hover {
            opacity: 0.8;
            stroke: #333;
            stroke-width: 2;
        }
        
        .bubble-label {
            font-family: 'Faustina', serif;
            pointer-events: none;
            text-anchor: middle;
            fill: white;
            font-weight: 600;
        }
        
        .legend-container {
            width: 690px;
            margin: 10px 0 0 0;
            padding: 0;
            font-family: 'Faustina', serif;
        }
        
        .legend-title {
            font-weight: 700;
            font-size: 12px;
            margin: 0 0 6px 0;
            color: #333;
            text-align: center;
        }
        
        .legend {
            width: 690px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        .legend-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            font-family: 'Faustina', serif;
            font-size: 9px;
            cursor: pointer;
            padding: 2px 3px;
            border-radius: 3px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .legend-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 4px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="chart"></div>
        <div class="legend-container">
            <div class="legend-title">Department</div>
            <div class="legend" id="legend"></div>
        </div>
    </div>
    <div class="tooltip"></div>
    
    <script>
        const data = {
            name: "Federal Statistical Agencies",
            children: [
                {
                    name: "Agriculture",
                    children: [
                        {name: "Economic Research Service (ERS)", value: 87.80},
                        {name: "National Agricultural Statistics Service (NASS)", value: 190.20}
                    ]
                },
                {
                    name: "Commerce",
                    children: [
                        {name: "Bureau of Economic Analysis (BEA)", value: 111.70},
                        {name: "Bureau of the Census", value: 1579.80}
                    ]
                },
                {
                    name: "Education",
                    children: [
                        {name: "National Center for Education Statistics (NCES)", value: 334.40}
                    ]
                },
                {
                    name: "Energy",
                    children: [
                        {name: "Energy Information Administration (EIA)", value: 129.00}
                    ]
                },
                {
                    name: "Health and Human Services",
                    children: [
                        {name: "National Center for Health Statistics (NCHS)", value: 180.40}
                    ]
                },
                {
                    name: "Justice",
                    children: [
                        {name: "Bureau of Justice Statistics (BJS)", value: 49.40}
                    ]
                },
                {
                    name: "Labor",
                    children: [
                        {name: "Bureau of Labor Statistics (BLS)", value: 688.00}
                    ]
                },
                {
                    name: "National Science Foundation",
                    children: [
                        {name: "National Center for Science and Engineering Statistics (NCSES)", value: 67.70}
                    ]
                },
                {
                    name: "Social Security Administration",
                    children: [
                        {name: "Office of Research, Evaluation, and Statistics (ORES)", value: 38.20}
                    ]
                },
                {
                    name: "Transportation",
                    children: [
                        {name: "Bureau of Transportation Statistics (BTS)", value: 30.80}
                    ]
                },
                {
                    name: "Treasury",
                    children: [
                        {name: "IRS Statistics of Income (SOI) Program", value: 42.40}
                    ]
                }
            ]
        };

        // ============================================
        // CHANGE COLORS HERE - Each department needs a unique color
        // ============================================
        const departmentColors = {
            "Agriculture": "#1B83C6",           // Blue
            "Commerce": "#05335D",              // Dark Blue
            "Education": "#B71D51",             // Red
            "Energy": "#F26961",                // Light Red
            "Health and Human Services": "#FCBB13",  // Yellow
            "Justice": "#7A4FA3",               // Purple
            "Labor": "#4CAF50",                 // Green
            "National Science Foundation": "#9C27B0",  // Violet
            "Social Security Administration": "#00BCD4",  // Cyan
            "Transportation": "#795548",        // Brown
            "Treasury": "#607D8B"               // Blue-Gray
        };
        // ============================================
        
        const width = 580;  // Reduced significantly to fit within 690px limit
        const height = 440; // Proportionally reduced height
        
        const departments = data.children.map(d => d.name);
        
        // Create legend with three rows for better width management
        const legend = d3.select("#legend");
        
        // Define which departments go in each row
        // Split into three rows for better width distribution
        const firstRowDepts = [
            "Agriculture",
            "Commerce", 
            "Education",
            "Energy"
        ];
        
        const secondRowDepts = [
            "Health and Human Services",
            "Justice",
            "Labor",
            "National Science Foundation"
        ];
        
        const thirdRowDepts = [
            "Social Security Administration",
            "Transportation",
            "Treasury"
        ];
        
        // Create first row
        const firstRow = legend.append("div")
            .attr("class", "legend-row");
        
        firstRowDepts.forEach(dept => {
            const item = firstRow.append("div")
                .attr("class", "legend-item")
                .attr("data-department", dept);
            item.append("div")
                .attr("class", "legend-color")
                .style("background-color", departmentColors[dept]);
            item.append("span")
                .text(dept);
        });
        
        // Create second row
        const secondRow = legend.append("div")
            .attr("class", "legend-row");
        
        secondRowDepts.forEach(dept => {
            const item = secondRow.append("div")
                .attr("class", "legend-item")
                .attr("data-department", dept);
            item.append("div")
                .attr("class", "legend-color")
                .style("background-color", departmentColors[dept]);
            item.append("span")
                .text(dept);
        });
        
        // Create third row
        const thirdRow = legend.append("div")
            .attr("class", "legend-row");
        
        thirdRowDepts.forEach(dept => {
            const item = thirdRow.append("div")
                .attr("class", "legend-item")
                .attr("data-department", dept);
            item.append("div")
                .attr("class", "legend-color")
                .style("background-color", departmentColors[dept]);
            item.append("span")
                .text(dept);
        });
        
        const pack = d3.pack()
            .size([width - 40, height - 40])  // Larger margins to prevent overflow
            .padding(8);  // More padding between bubbles
        
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);
        
        pack(root);
        
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", 580)  // Fixed width in pixels
            .attr("height", 440) // Fixed height in pixels
            .style("width", "580px")
            .style("height", "440px")
            .style("display", "block");
        
        const tooltip = d3.select(".tooltip");
        
        const nodes = svg.selectAll(".node")
            .data(root.descendants().filter(d => d.depth === 2))
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x + 20},${d.y + 20})`);  // 20px offset for margins
        
        const bubbles = nodes.append("circle")
            .attr("class", "bubble")
            .attr("data-department", d => d.parent.data.name)
            .attr("r", d => d.r)
            .style("fill", d => departmentColors[d.parent.data.name])
            .style("fill-opacity", 0.8)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>
                    Department: ${d.parent.data.name}<br/>
                    Funding: $${d.data.value.toFixed(1)}M`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
        
        // Add labels for bubbles
        nodes.each(function(d) {
            const node = d3.select(this);
            const text = node.append("text")
                .attr("class", "bubble-label")
                .attr("dy", ".3em");
            
            // For very large bubbles (like Census), show full name or acronym
            if (d.r > 60) {
                // Special case for very long names
                if (d.data.name.includes("Census")) {
                    text.style("font-size", "12px").text("Census");
                } else {
                    // Extract acronym if available
                    const match = d.data.name.match(/\(([^)]+)\)/);
                    if (match) {
                        text.style("font-size", "12px").text(match[1]);
                    } else {
                        text.style("font-size", "12px").text(d.data.name.split(' ')[0]);
                    }
                }
            }
            // For large bubbles, show acronym or abbreviated name
            else if (d.r > 40) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                if (match) {
                    text.style("font-size", "10px").text(match[1]);
                } else {
                    text.style("font-size", "10px").text(d.data.name.split(' ')[0]);
                }
            }
            // For medium bubbles, show acronym or short name
            else if (d.r > 22) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                if (match) {
                    text.style("font-size", "8px").text(match[1]);
                } else {
                    const firstWord = d.data.name.split(' ')[0];
                    const shortened = firstWord.length > 6 ? firstWord.substring(0, 4) + "." : firstWord;
                    text.style("font-size", "8px").text(shortened);
                }
            }
            // For smaller bubbles, show acronym if short enough
            else if (d.r > 14) {
                const match = d.data.name.match(/\(([^)]+)\)/);
                if (match && match[1].length <= 6) {
                    text.style("font-size", "6px").text(match[1]);
                }
                // Otherwise don't show text for tiny bubbles
            }
        });
        
        // Add interactive filtering on legend hover
        d3.selectAll(".legend-item")  // This will select items from both rows
            .on("mouseenter", function(event) {
                const hoveredDept = d3.select(this).attr("data-department");
                
                // Dim all bubbles except the hovered department
                bubbles.transition()
                    .duration(200)
                    .style("opacity", d => d.parent.data.name === hoveredDept ? 1 : 0.2);
                
                // Also dim the labels
                nodes.selectAll(".bubble-label")
                    .transition()
                    .duration(200)
                    .style("opacity", function() {
                        const parentNode = d3.select(this.parentNode).datum();
                        return parentNode.parent.data.name === hoveredDept ? 1 : 0.2;
                    });
            })
            .on("mouseleave", function() {
                // Reset all bubbles to normal opacity
                bubbles.transition()
                    .duration(200)
                    .style("opacity", 0.8);
                
                // Reset all labels
                nodes.selectAll(".bubble-label")
                    .transition()
                    .duration(200)
                    .style("opacity", 1);
            });
    </script>
</body>
</html>
